name: Build and Test with Firebase Test Lab (Android and iOS)

on:
  schedule:
    - cron: '0 0 * * *' # Chạy mỗi ngày lúc 00:00 UTC
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  release:
    types:
      - created
      

jobs:
  # Job 1: Build và Test Android App
  build-android:
    runs-on: ubuntu-latest

    steps:
    # Bước 1: Lấy mã nguồn
    - name: Checkout repository
      uses: actions/checkout@v4
    # Bước 2: Cài đặt JDK 11
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
    # Bước 3: Cài đặt Android SDK
    - name: Set up Android SDK
      run: |
        sudo apt update
        sudo apt install -y openjdk-11-jdk
        mkdir -p $HOME/android-sdk
        cd $HOME/android-sdk
        wget https://dl.google.com/android/repository/commandlinetools-linux-8092744_latest.zip
        unzip commandlinetools-linux-8092744_latest.zip -d cmdline-tools
        yes | cmdline-tools/tools/bin/sdkmanager --licenses
        cmdline-tools/tools/bin/sdkmanager "platform-tools" "build-tools;30.0.3" "platforms;android-30"
    # Bước 4: Cài đặt Firebase CLI
    - name: Set up Firebase CLI
      run: |
        npm install -g firebase-tools
    # Bước 5: Xác thực với Firebase
    - name: Authenticate with Firebase
      env:
        GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
      run: |
        echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > /tmp/firebase-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-key.json
    # Bước 6: Cài đặt các thư viện phụ thuộc
    - name: Install dependencies
      run: npm install
    # Bước 7: Build Android App
    - name: Build Android app
      run: cd android && ./gradlew assembleRelease
    # Bước 8: Tải APK lên Firebase Test Lab và chạy kiểm thử
    - name: Run tests on Firebase Test Lab
      run: |
        firebase test android run \
          --app android/app/build/outputs/apk/release/app-release.apk \
          --device model=Pixel3,version=30,locale=en,orientation=portrait \
          --timeout 15m \
          --results-dir=results
    # Bước 9: Tải kết quả kiểm thử
    - name: Upload Firebase Test Lab results
      uses: actions/upload-artifact@v4
      with:
            name: firebase-test-results
            path: results/
        
  
   
   
  # Job 2: Build iOS App
  build-ios:
    runs-on: macos-latest
    needs: build-android # Chạy sau khi Android hoàn thành

    steps:
    # Bước 1: Lấy mã nguồn
    - name: Checkout repository
      uses: actions/checkout@v4
    # Bước 2: Cài đặt Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '21'
    # Bước 3: Cài đặt các thư viện phụ thuộc
    - name: Install dependencies
      run: npm install
    # Bước 4: Cài đặt CocoaPods
    - name: Install CocoaPods
      run: |
        sudo gem install cocoapods
        cd ios && pod install
    # Bước 5: Build iOS app
    - name: Build iOS app
      run: |
        xcodebuild \
          -workspace ios/MyApp.xcworkspace \
          -scheme MyApp \
          -configuration Release \
          -sdk iphoneos \
          -archivePath $PWD/build/MyApp.xcarchive \
          archive
    # Bước 6: Export IPA file
    - name: Export IPA
      run: |
        xcodebuild \
          -exportArchive \
          -archivePath $PWD/build/MyApp.xcarchive \
          -exportOptionsPlist ios/exportOptions.plist \
          -exportPath $PWD/build
    # Bước 7: Tải artifact IPA file
    - name: Upload iOS IPA artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-build
        path: ios/build/*.ipa